{
    "properties": {
      "displayName": "Deploy extension to register virtual machines to Azure State Configuration",
      "mode": "All",
      "description": "When virtual machines are deployed, automatically register them to be managed by Azure State Configuration.",
      "parameters": {
        "azureAutomation": {
          "type": "String",
          "metadata": {
            "displayName": "Required: Azure Automation account",
            "description": "Select Azure Automation account from dropdown list",
            "strongType": "azureAutomation"
          }
        },
        "configName": {
          "type": "String",
          "metadata": {
            "displayName": "Optional: Node configuration name",
            "description": "Specify a node configuration name if you would like to apply a configuration during registration. If empty, no configuration will be applied."
          },
          "defaultValue": ""
        }
      },
      "policyRule": {
        "if": {
          "allOf": [
            {
              "field": "type",
              "equals": "Microsoft.Compute/virtualMachines"
            },
            {
              "anyOf": [
                {
                    "allOf": [
                        {
                            "field": "type",
                            "equals": "Microsoft.Compute/virtualMachines"
                        },
                        {
                            "anyOf": [
                                {
                                    "field": "Microsoft.Compute/imagePublisher",
                                    "in": [
                                        "esri",
                                        "incredibuild",
                                        "MicrosoftDynamicsAX",
                                        "MicrosoftSharepoint",
                                        "MicrosoftVisualStudio",
                                        "MicrosoftWindowsDesktop",
                                        "MicrosoftWindowsServerHPCPack"
                                    ]
                                },
                                {
                                    "allOf": [
                                        {
                                            "field": "Microsoft.Compute/imagePublisher",
                                            "equals": "MicrosoftWindowsServer"
                                        }
                                    ]
                                },
                                {
                                    "allOf": [
                                        {
                                            "field": "Microsoft.Compute/imagePublisher",
                                            "equals": "MicrosoftSQLServer"
                                        },
                                        {
                                            "field": "Microsoft.Compute/imageSKU",
                                            "notEquals": "SQL2008R2SP3-WS2008R2SP1"
                                        }
                                    ]
                                },
                                {
                                    "allOf": [
                                        {
                                            "field": "Microsoft.Compute/imagePublisher",
                                            "equals": "microsoft-dsvm"
                                        },
                                        {
                                            "field": "Microsoft.Compute/imageOffer",
                                            "equals": "dsvm-windows"
                                        }
                                    ]
                                },
                                {
                                    "allOf": [
                                        {
                                            "field": "Microsoft.Compute/imagePublisher",
                                            "equals": "microsoft-ads"
                                        },
                                        {
                                            "field": "Microsoft.Compute/imageOffer",
                                            "in": [
                                                "standard-data-science-vm",
                                                "windows-data-science-vm"
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "allOf": [
                                        {
                                            "field": "Microsoft.Compute/imagePublisher",
                                            "equals": "batch"
                                        },
                                        {
                                            "field": "Microsoft.Compute/imageOffer",
                                            "equals": "rendering-windows2016"
                                        }
                                    ]
                                },
                                {
                                    "allOf": [
                                        {
                                            "field": "Microsoft.Compute/imagePublisher",
                                            "equals": "center-for-internet-security-inc"
                                        },
                                        {
                                            "field": "Microsoft.Compute/imageOffer",
                                            "like": "cis-windows-server-201*"
                                        }
                                    ]
                                },
                                {
                                    "allOf": [
                                        {
                                            "field": "Microsoft.Compute/imagePublisher",
                                            "equals": "pivotal"
                                        },
                                        {
                                            "field": "Microsoft.Compute/imageOffer",
                                            "like": "bosh-windows-server*"
                                        }
                                    ]
                                },
                                {
                                    "allOf": [
                                        {
                                            "field": "Microsoft.Compute/imagePublisher",
                                            "equals": "cloud-infrastructure-services"
                                        },
                                        {
                                            "field": "Microsoft.Compute/imageOffer",
                                            "like": "ad*"
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                  "allOf": [
                    {
                      "field": "Microsoft.Compute/imagePublisher",
                      "equals": "Canonical"
                    },
                    {
                      "field": "Microsoft.Compute/imageOffer",
                      "equals": "UbuntuServer"
                    },
                    {
                      "anyOf": [
                        {
                          "field": "Microsoft.Compute/imageSKU",
                          "match": "14.04.#-LTS"
                        },
                        {
                          "field": "Microsoft.Compute/imageSKU",
                          "match": "16.04.#-LTS"
                        },
                        {
                          "field": "Microsoft.Compute/imageSKU",
                          "match": "18.04.#-LTS"
                        }
                      ]
                    }
                  ]
                },
                {
                  "allOf": [
                    {
                      "field": "Microsoft.Compute/imagePublisher",
                      "equals": "Suse"
                    },
                    {
                      "field": "Microsoft.Compute/imageOffer",
                      "equals": "SLES"
                    },
                    {
                      "field": "Microsoft.Compute/imageSKU",
                      "equals": "12-SP3"
                    }
                  ]
                },
                {
                  "allOf": [
                    {
                      "field": "Microsoft.Compute/imagePublisher",
                      "equals": "RedHat"
                    },
                    {
                      "field": "Microsoft.Compute/imageOffer",
                      "equals": "RHEL"
                    },
                    {
                      "field": "Microsoft.Compute/imageSKU",
                      "in": [
                        "7-RAW",
                        "7.4",
                        "7.2"
                      ]
                    }
                  ]
                },
                {
                  "allOf": [
                    {
                      "field": "Microsoft.Compute/imagePublisher",
                      "equals": "credativ"
                    },
                    {
                      "field": "Microsoft.Compute/imageOffer",
                      "equals": "Debian"
                    },
                    {
                      "field": "Microsoft.Compute/imageSKU",
                      "in": [
                        "9",
                        "8"
                      ]
                    }
                  ]
                },
                {
                  "allOf": [
                    {
                      "field": "Microsoft.Compute/imagePublisher",
                      "equals": "OpenLogic"
                    },
                    {
                      "field": "Microsoft.Compute/imageOffer",
                      "equals": "CentOS"
                    },
                    {
                      "field": "Microsoft.Compute/imageSKU",
                      "in": [
                        "7.5",
                        "7.4",
                        "7.3"
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        "then": {
          "effect": "deployIfNotExists",
          "details": {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "roleDefinitionIds": [
              "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
            ],
            "existenceCondition": {
              "anyOf": [
                {
                  "allOf": [
                    {
                      "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                      "equals": "Microsoft.Powershell"
                    },
                    {
                      "field": "Microsoft.Compute/virtualMachines/extensions/type",
                      "equals": "DSC"
                    }
                  ]
                },
                {
                  "allOf": [
                    {
                      "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                      "equals": "Microsoft.OSTCExtensions"
                    },
                    {
                      "field": "Microsoft.Compute/virtualMachines/extensions/type",
                      "equals": "DSCforLinux"
                    }
                  ]
                }
              ]
            },
            "deployment": {
              "properties": {
                "mode": "incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "vmName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "imagePublisher": {
                      "type": "string"
                    },
                    "azureAutomation": {
                      "type": "string"
                    },
                    "configName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "linuxPublishers": [
                      "Canonical",
                      "Suse",
                      "RedHat",
                      "credativ",
                      "OpenLogic"
                    ]
                  },
                  "resources": [
                    {
                      "condition": "[equals(parameters('ImagePublisher'), 'MicrosoftWindowsServer')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "name": "[concat(parameters('VMName'),'/Microsoft.Powershell.DSC')]",
                      "apiVersion": "2018-04-01",
                      "location": "[resourceGroup().location]",
                      "properties": {
                        "publisher": "Microsoft.Powershell",
                        "type": "DSC",
                        "typeHandlerVersion": "2.78",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "configurationArguments": {
                            "RegistrationUrl": "[reference(parameters('azureAutomation')).registrationUrl]",
                            "NodeConfigurationName": "[parameters('configName')]"
                          }
                        },
                        "protectedSettings": {
                          "configurationArguments": {
                            "RegistrationKey": {
                              "userName": "NOT_USED",
                              "Password": "[listKeys(parameters('azureAutomation'), '2018-01-15').Keys[0].value]"
                            }
                          }
                        }
                      }
                    },
                    {
                      "condition": "[contains(variables('linuxPublishers'), parameters('imagePublisher'))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "name": "[concat(parameters('vmName'),'/StateConfigurationLinux')]",
                      "location": "[parameters('location')]",
                      "apiVersion": "2015-05-01-preview",
                      "properties": {
                        "publisher": "Microsoft.OSTCExtensions",
                        "type": "DSCForLinux",
                        "typeHandlerVersion": "2.0",
                        "settings": {
                          "Mode": "Register"
                        },
                        "protectedSettings": {
                          "RegistrationURI": "[reference(parameters('azureAutomation')).registrationUrl]",
                          "RegistrationKey": "[listKeys(parameters('azureAutomation'), '2018-01-15').Keys[0].value]"
                        }
                      }
                    }
                  ]
                },
                "parameters": {
                  "vmName": {
                    "value": "[field('name')]"
                  },
                  "location": {
                    "value": "[field('location')]"
                  },
                  "imagePublisher": {
                    "value": "[field('Microsoft.Compute/virtualMachines/imagePublisher')]"
                  },
                  "azureAutomation": {
                    "value": "[parameters('azureAutomation')]"
                  },
                  "configName": {
                    "value": "[parameters('configName')]"
                  }
                }
              }
            }
          }
        }
      }
    }
  }