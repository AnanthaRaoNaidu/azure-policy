{
  "id": "/providers/Microsoft.Authorization/policyDefinitions/36e17963-7202-494a-80c3-f508211c826b",
  "name": "36e17963-7202-494a-80c3-f508211c826b",
  "properties": {
    "policyType": "BuiltIn",
    "metadata": {
      "category": "Guest Configuration",
      "version": "1.0.0",
      "preview": true,
      "requiredProviders": [
        "Microsoft.GuestConfiguration"
      ]
    },
    "parameters": {
      "NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCClients": {
        "type": "string",
        "metadata": {
          "description": "Specifies which behaviors are allowed by clients for applications using the NTLM Security Support Provider (SSP). The SSP Interface (SSPI) is used by applications that need authentication services. See https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-minimum-session-security-for-ntlm-ssp-based-including-secure-rpc-servers for more information.",
          "displayName": "Network security: Minimum session security for NTLM SSP based (including secure RPC) clients"
        },
        "defaultValue": "537395200"
      },
      "NetworkSecurityConfigureEncryptionTypesAllowedForKerberos": {
        "type": "string",
        "metadata": {
          "description": "Specifies the encryption types that Kerberos is allowed to use.",
          "displayName": "Network Security: Configure encryption types allowed for Kerberos"
        },
        "defaultValue": "2147483644"
      },
      "NetworkSecurityLDAPClientSigningRequirements": {
        "type": "string",
        "metadata": {
          "description": "Specify the level of data signing that is requested on behalf of clients that issue LDAP BIND requests.",
          "displayName": "Network security: LDAP client signing requirements"
        },
        "defaultValue": "1"
      },
      "NetworkSecurityLANManagerAuthenticationLevel": {
        "type": "string",
        "metadata": {
          "description": "Specify which challenge-response authentication protocol is used for network logons. This choice affects the level of authentication protocol used by clients, the level of session security negotiated, and the level of authentication accepted by servers.",
          "displayName": "Network security: LAN Manager authentication level"
        },
        "defaultValue": "5"
      },
      "NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCServers": {
        "type": "string",
        "metadata": {
          "description": "Specifies which behaviors are allowed by servers for applications using the NTLM Security Support Provider (SSP). The SSP Interface (SSPI) is used by applications that need authentication services.",
          "displayName": "Network security: Minimum session security for NTLM SSP based (including secure RPC) servers"
        },
        "defaultValue": "537395200"
      }
    },
    "displayName": "Deploy prerequisites to audit Windows VMs configurations in 'Security Options - Network Security'",
    "policyRule": {
      "then": {
        "details": {
          "existenceCondition": {
            "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/parameterHash",
            "equals": "[base64(concat('Network Security: Configure encryption types allowed for Kerberos;ExpectedValue', '=', parameters('NetworkSecurityConfigureEncryptionTypesAllowedForKerberos'), ',', 'Network security: LAN Manager authentication level;ExpectedValue', '=', parameters('NetworkSecurityLANManagerAuthenticationLevel'), ',', 'Network security: LDAP client signing requirements;ExpectedValue', '=', parameters('NetworkSecurityLDAPClientSigningRequirements'), ',', 'Network security: Minimum session security for NTLM SSP based (including secure RPC) clients;ExpectedValue', '=', parameters('NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCClients'), ',', 'Network security: Minimum session security for NTLM SSP based (including secure RPC) servers;ExpectedValue', '=', parameters('NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCServers')))]"
          },
          "type": "Microsoft.GuestConfiguration/guestConfigurationAssignments",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "name": "AzureBaseline_SecurityOptionsNetworkSecurity",
          "deployment": {
            "properties": {
              "parameters": {
                "configurationName": {
                  "value": "AzureBaseline_SecurityOptionsNetworkSecurity"
                },
                "type": {
                  "value": "[field('type')]"
                },
                "NetworkSecurityConfigureEncryptionTypesAllowedForKerberos": {
                  "value": "[parameters('NetworkSecurityConfigureEncryptionTypesAllowedForKerberos')]"
                },
                "NetworkSecurityLANManagerAuthenticationLevel": {
                  "value": "[parameters('NetworkSecurityLANManagerAuthenticationLevel')]"
                },
                "NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCServers": {
                  "value": "[parameters('NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCServers')]"
                },
                "location": {
                  "value": "[field('location')]"
                },
                "NetworkSecurityLDAPClientSigningRequirements": {
                  "value": "[parameters('NetworkSecurityLDAPClientSigningRequirements')]"
                },
                "vmName": {
                  "value": "[field('name')]"
                },
                "NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCClients": {
                  "value": "[parameters('NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCClients')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "parameters": {
                  "configurationName": {
                    "type": "string"
                  },
                  "type": {
                    "type": "string"
                  },
                  "NetworkSecurityConfigureEncryptionTypesAllowedForKerberos": {
                    "type": "string"
                  },
                  "NetworkSecurityLANManagerAuthenticationLevel": {
                    "type": "string"
                  },
                  "NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCServers": {
                    "type": "string"
                  },
                  "location": {
                    "type": "string"
                  },
                  "NetworkSecurityLDAPClientSigningRequirements": {
                    "type": "string"
                  },
                  "vmName": {
                    "type": "string"
                  },
                  "NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCClients": {
                    "type": "string"
                  }
                },
                "contentVersion": "1.0.0.0",
                "resources": [
                  {
                    "properties": {
                      "guestConfiguration": {
                        "version": "1.*",
                        "configurationParameter": [
                          {
                            "value": "[parameters('NetworkSecurityConfigureEncryptionTypesAllowedForKerberos')]",
                            "name": "Network Security: Configure encryption types allowed for Kerberos;ExpectedValue"
                          },
                          {
                            "value": "[parameters('NetworkSecurityLANManagerAuthenticationLevel')]",
                            "name": "Network security: LAN Manager authentication level;ExpectedValue"
                          },
                          {
                            "value": "[parameters('NetworkSecurityLDAPClientSigningRequirements')]",
                            "name": "Network security: LDAP client signing requirements;ExpectedValue"
                          },
                          {
                            "value": "[parameters('NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCClients')]",
                            "name": "Network security: Minimum session security for NTLM SSP based (including secure RPC) clients;ExpectedValue"
                          },
                          {
                            "value": "[parameters('NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCServers')]",
                            "name": "Network security: Minimum session security for NTLM SSP based (including secure RPC) servers;ExpectedValue"
                          }
                        ],
                        "name": "[parameters('configurationName')]"
                      }
                    },
                    "name": "[concat(parameters('vmName'), '/Microsoft.GuestConfiguration/', parameters('configurationName'))]",
                    "location": "[parameters('location')]",
                    "condition": "[equals(toLower(parameters('type')), toLower('microsoft.hybridcompute/machines'))]",
                    "apiVersion": "2018-11-20",
                    "type": "Microsoft.HybridCompute/machines/providers/guestConfigurationAssignments"
                  },
                  {
                    "properties": {
                      "guestConfiguration": {
                        "version": "1.*",
                        "configurationParameter": [
                          {
                            "value": "[parameters('NetworkSecurityConfigureEncryptionTypesAllowedForKerberos')]",
                            "name": "Network Security: Configure encryption types allowed for Kerberos;ExpectedValue"
                          },
                          {
                            "value": "[parameters('NetworkSecurityLANManagerAuthenticationLevel')]",
                            "name": "Network security: LAN Manager authentication level;ExpectedValue"
                          },
                          {
                            "value": "[parameters('NetworkSecurityLDAPClientSigningRequirements')]",
                            "name": "Network security: LDAP client signing requirements;ExpectedValue"
                          },
                          {
                            "value": "[parameters('NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCClients')]",
                            "name": "Network security: Minimum session security for NTLM SSP based (including secure RPC) clients;ExpectedValue"
                          },
                          {
                            "value": "[parameters('NetworkSecurityMinimumSessionSecurityForNTLMSSPBasedIncludingSecureRPCServers')]",
                            "name": "Network security: Minimum session security for NTLM SSP based (including secure RPC) servers;ExpectedValue"
                          }
                        ],
                        "name": "[parameters('configurationName')]"
                      }
                    },
                    "name": "[concat(parameters('vmName'), '/Microsoft.GuestConfiguration/', parameters('configurationName'))]",
                    "location": "[parameters('location')]",
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2018-11-20",
                    "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments"
                  },
                  {
                    "name": "[parameters('vmName')]",
                    "location": "[parameters('location')]",
                    "identity": {
                      "type": "SystemAssigned"
                    },
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2017-03-30",
                    "type": "Microsoft.Compute/virtualMachines"
                  },
                  {
                    "properties": {
                      "autoUpgradeMinorVersion": true,
                      "settings": {},
                      "publisher": "Microsoft.GuestConfiguration",
                      "protectedSettings": {},
                      "typeHandlerVersion": "1.1",
                      "type": "ConfigurationforWindows"
                    },
                    "name": "[concat(parameters('vmName'), '/AzurePolicyforWindows')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                      "[concat('Microsoft.Compute/virtualMachines/',parameters('vmName'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',parameters('configurationName'))]"
                    ],
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2015-05-01-preview",
                    "type": "Microsoft.Compute/virtualMachines/extensions"
                  }
                ]
              },
              "mode": "incremental"
            }
          }
        },
        "effect": "deployIfNotExists"
      },
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Compute/virtualMachines"
              },
              {
                "anyOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "in": [
                      "esri",
                      "incredibuild",
                      "MicrosoftDynamicsAX",
                      "MicrosoftSharepoint",
                      "MicrosoftVisualStudio",
                      "MicrosoftWindowsDesktop",
                      "MicrosoftWindowsServerHPCPack"
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "MicrosoftWindowsServer"
                      },
                      {
                        "notLike": "2008*",
                        "field": "Microsoft.Compute/imageSKU"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "MicrosoftSQLServer"
                      },
                      {
                        "notLike": "SQL2008*",
                        "field": "Microsoft.Compute/imageOffer"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "microsoft-dsvm"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "dsvm-windows"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "microsoft-ads"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "in": [
                          "standard-data-science-vm",
                          "windows-data-science-vm"
                        ]
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "batch"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "rendering-windows2016"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "center-for-internet-security-inc"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "cis-windows-server-201*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "pivotal"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "bosh-windows-server*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "cloud-infrastructure-services"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "ad*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "anyOf": [
                          {
                            "exists": "true",
                            "field": "Microsoft.Compute/virtualMachines/osProfile.windowsConfiguration"
                          },
                          {
                            "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                            "like": "Windows*"
                          }
                        ]
                      },
                      {
                        "anyOf": [
                          {
                            "exists": "false",
                            "field": "Microsoft.Compute/imageSKU"
                          },
                          {
                            "allOf": [
                              {
                                "notLike": "2008*",
                                "field": "Microsoft.Compute/imageSKU"
                              },
                              {
                                "notLike": "SQL2008*",
                                "field": "Microsoft.Compute/imageOffer"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.HybridCompute/machines"
              },
              {
                "field": "Microsoft.HybridCompute/imageOffer",
                "like": "windows*"
              }
            ]
          }
        ]
      }
    },
    "description": "This policy creates a Guest Configuration assignment to audit Windows virtual machines with non-compliant settings in Group Policy category: 'Security Options - Network Security'. It also creates a system-assigned managed identity and deploys the VM extension for Guest Configuration. This policy should only be used along with its corresponding audit policy in an initiative. For more information on Guest Configuration policies, please visit https://aka.ms/gcpol",
    "mode": "Indexed"
  }
}
