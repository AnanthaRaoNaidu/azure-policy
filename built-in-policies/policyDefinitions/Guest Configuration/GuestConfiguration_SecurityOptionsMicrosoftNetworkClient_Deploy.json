{
  "id": "/providers/Microsoft.Authorization/policyDefinitions/bbcdd8fa-b600-4ee3-85b8-d184e3339652",
  "name": "bbcdd8fa-b600-4ee3-85b8-d184e3339652",
  "properties": {
    "policyType": "BuiltIn",
    "metadata": {
      "category": "Guest Configuration",
      "version": "1.0.0",
      "preview": true,
      "requiredProviders": [
        "Microsoft.GuestConfiguration"
      ]
    },
    "parameters": {
      "MicrosoftNetworkServerAmountOfIdleTimeRequiredBeforeSuspendingSession": {
        "type": "string",
        "metadata": {
          "description": "Specifies the amount of continuous idle time that must pass in an SMB session before the session is suspended because of inactivity. The format of the value is two integers separated by a comma, denoting an inclusive range.",
          "displayName": "Microsoft network server: Amount of idle time required before suspending session"
        },
        "defaultValue": "1,15"
      },
      "MicrosoftNetworkServerDisconnectClientsWhenLogonHoursExpire": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether to disconnect users who are connected to the local computer outside their user account's valid logon hours. This setting affects the Server Message Block (SMB) component. If you enable this policy setting you should also enable 'Network security: Force logoff when logon hours expire'",
          "displayName": "Microsoft network server: Disconnect clients when logon hours expire"
        },
        "defaultValue": "1"
      },
      "MicrosoftNetworkClientDigitallySignCommunicationsAlways": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether packet signing is required by the SMB client component.",
          "displayName": "Microsoft network client: Digitally sign communications (always)"
        },
        "defaultValue": "1"
      },
      "MicrosoftNetworkClientSendUnencryptedPasswordToThirdpartySMBServers": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether the SMB redirector will send plaintext passwords during authentication to third-party SMB servers that do not support password encryption. It is recommended that you disable this policy setting unless there is a strong business case to enable it.",
          "displayName": "Microsoft network client: Send unencrypted password to third-party SMB servers"
        },
        "defaultValue": "0"
      },
      "MicrosoftNetworkServerDigitallySignCommunicationsAlways": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether packet signing is required by the SMB server component.",
          "displayName": "Microsoft network server: Digitally sign communications (always)"
        },
        "defaultValue": "1"
      }
    },
    "displayName": "Deploy prerequisites to audit Windows VMs configurations in 'Security Options - Microsoft Network Client'",
    "policyRule": {
      "then": {
        "details": {
          "existenceCondition": {
            "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/parameterHash",
            "equals": "[base64(concat('Microsoft network client: Digitally sign communications (always);ExpectedValue', '=', parameters('MicrosoftNetworkClientDigitallySignCommunicationsAlways'), ',', 'Microsoft network client: Send unencrypted password to third-party SMB servers;ExpectedValue', '=', parameters('MicrosoftNetworkClientSendUnencryptedPasswordToThirdpartySMBServers'), ',', 'Microsoft network server: Amount of idle time required before suspending session;ExpectedValue', '=', parameters('MicrosoftNetworkServerAmountOfIdleTimeRequiredBeforeSuspendingSession'), ',', 'Microsoft network server: Digitally sign communications (always);ExpectedValue', '=', parameters('MicrosoftNetworkServerDigitallySignCommunicationsAlways'), ',', 'Microsoft network server: Disconnect clients when logon hours expire;ExpectedValue', '=', parameters('MicrosoftNetworkServerDisconnectClientsWhenLogonHoursExpire')))]"
          },
          "type": "Microsoft.GuestConfiguration/guestConfigurationAssignments",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "name": "AzureBaseline_SecurityOptionsMicrosoftNetworkClient",
          "deployment": {
            "properties": {
              "parameters": {
                "configurationName": {
                  "value": "AzureBaseline_SecurityOptionsMicrosoftNetworkClient"
                },
                "type": {
                  "value": "[field('type')]"
                },
                "MicrosoftNetworkServerDigitallySignCommunicationsAlways": {
                  "value": "[parameters('MicrosoftNetworkServerDigitallySignCommunicationsAlways')]"
                },
                "MicrosoftNetworkServerDisconnectClientsWhenLogonHoursExpire": {
                  "value": "[parameters('MicrosoftNetworkServerDisconnectClientsWhenLogonHoursExpire')]"
                },
                "MicrosoftNetworkClientSendUnencryptedPasswordToThirdpartySMBServers": {
                  "value": "[parameters('MicrosoftNetworkClientSendUnencryptedPasswordToThirdpartySMBServers')]"
                },
                "MicrosoftNetworkClientDigitallySignCommunicationsAlways": {
                  "value": "[parameters('MicrosoftNetworkClientDigitallySignCommunicationsAlways')]"
                },
                "location": {
                  "value": "[field('location')]"
                },
                "vmName": {
                  "value": "[field('name')]"
                },
                "MicrosoftNetworkServerAmountOfIdleTimeRequiredBeforeSuspendingSession": {
                  "value": "[parameters('MicrosoftNetworkServerAmountOfIdleTimeRequiredBeforeSuspendingSession')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "parameters": {
                  "configurationName": {
                    "type": "string"
                  },
                  "type": {
                    "type": "string"
                  },
                  "MicrosoftNetworkServerDigitallySignCommunicationsAlways": {
                    "type": "string"
                  },
                  "MicrosoftNetworkServerDisconnectClientsWhenLogonHoursExpire": {
                    "type": "string"
                  },
                  "MicrosoftNetworkClientSendUnencryptedPasswordToThirdpartySMBServers": {
                    "type": "string"
                  },
                  "MicrosoftNetworkClientDigitallySignCommunicationsAlways": {
                    "type": "string"
                  },
                  "location": {
                    "type": "string"
                  },
                  "vmName": {
                    "type": "string"
                  },
                  "MicrosoftNetworkServerAmountOfIdleTimeRequiredBeforeSuspendingSession": {
                    "type": "string"
                  }
                },
                "contentVersion": "1.0.0.0",
                "resources": [
                  {
                    "properties": {
                      "guestConfiguration": {
                        "version": "1.*",
                        "configurationParameter": [
                          {
                            "value": "[parameters('MicrosoftNetworkClientDigitallySignCommunicationsAlways')]",
                            "name": "Microsoft network client: Digitally sign communications (always);ExpectedValue"
                          },
                          {
                            "value": "[parameters('MicrosoftNetworkClientSendUnencryptedPasswordToThirdpartySMBServers')]",
                            "name": "Microsoft network client: Send unencrypted password to third-party SMB servers;ExpectedValue"
                          },
                          {
                            "value": "[parameters('MicrosoftNetworkServerAmountOfIdleTimeRequiredBeforeSuspendingSession')]",
                            "name": "Microsoft network server: Amount of idle time required before suspending session;ExpectedValue"
                          },
                          {
                            "value": "[parameters('MicrosoftNetworkServerDigitallySignCommunicationsAlways')]",
                            "name": "Microsoft network server: Digitally sign communications (always);ExpectedValue"
                          },
                          {
                            "value": "[parameters('MicrosoftNetworkServerDisconnectClientsWhenLogonHoursExpire')]",
                            "name": "Microsoft network server: Disconnect clients when logon hours expire;ExpectedValue"
                          }
                        ],
                        "name": "[parameters('configurationName')]"
                      }
                    },
                    "name": "[concat(parameters('vmName'), '/Microsoft.GuestConfiguration/', parameters('configurationName'))]",
                    "location": "[parameters('location')]",
                    "condition": "[equals(toLower(parameters('type')), toLower('microsoft.hybridcompute/machines'))]",
                    "apiVersion": "2018-11-20",
                    "type": "Microsoft.HybridCompute/machines/providers/guestConfigurationAssignments"
                  },
                  {
                    "properties": {
                      "guestConfiguration": {
                        "version": "1.*",
                        "configurationParameter": [
                          {
                            "value": "[parameters('MicrosoftNetworkClientDigitallySignCommunicationsAlways')]",
                            "name": "Microsoft network client: Digitally sign communications (always);ExpectedValue"
                          },
                          {
                            "value": "[parameters('MicrosoftNetworkClientSendUnencryptedPasswordToThirdpartySMBServers')]",
                            "name": "Microsoft network client: Send unencrypted password to third-party SMB servers;ExpectedValue"
                          },
                          {
                            "value": "[parameters('MicrosoftNetworkServerAmountOfIdleTimeRequiredBeforeSuspendingSession')]",
                            "name": "Microsoft network server: Amount of idle time required before suspending session;ExpectedValue"
                          },
                          {
                            "value": "[parameters('MicrosoftNetworkServerDigitallySignCommunicationsAlways')]",
                            "name": "Microsoft network server: Digitally sign communications (always);ExpectedValue"
                          },
                          {
                            "value": "[parameters('MicrosoftNetworkServerDisconnectClientsWhenLogonHoursExpire')]",
                            "name": "Microsoft network server: Disconnect clients when logon hours expire;ExpectedValue"
                          }
                        ],
                        "name": "[parameters('configurationName')]"
                      }
                    },
                    "name": "[concat(parameters('vmName'), '/Microsoft.GuestConfiguration/', parameters('configurationName'))]",
                    "location": "[parameters('location')]",
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2018-11-20",
                    "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments"
                  },
                  {
                    "name": "[parameters('vmName')]",
                    "location": "[parameters('location')]",
                    "identity": {
                      "type": "SystemAssigned"
                    },
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2017-03-30",
                    "type": "Microsoft.Compute/virtualMachines"
                  },
                  {
                    "properties": {
                      "autoUpgradeMinorVersion": true,
                      "settings": {},
                      "publisher": "Microsoft.GuestConfiguration",
                      "protectedSettings": {},
                      "typeHandlerVersion": "1.1",
                      "type": "ConfigurationforWindows"
                    },
                    "name": "[concat(parameters('vmName'), '/AzurePolicyforWindows')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                      "[concat('Microsoft.Compute/virtualMachines/',parameters('vmName'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',parameters('configurationName'))]"
                    ],
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2015-05-01-preview",
                    "type": "Microsoft.Compute/virtualMachines/extensions"
                  }
                ]
              },
              "mode": "incremental"
            }
          }
        },
        "effect": "deployIfNotExists"
      },
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Compute/virtualMachines"
              },
              {
                "anyOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "in": [
                      "esri",
                      "incredibuild",
                      "MicrosoftDynamicsAX",
                      "MicrosoftSharepoint",
                      "MicrosoftVisualStudio",
                      "MicrosoftWindowsDesktop",
                      "MicrosoftWindowsServerHPCPack"
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "MicrosoftWindowsServer"
                      },
                      {
                        "notLike": "2008*",
                        "field": "Microsoft.Compute/imageSKU"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "MicrosoftSQLServer"
                      },
                      {
                        "notLike": "SQL2008*",
                        "field": "Microsoft.Compute/imageOffer"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "microsoft-dsvm"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "dsvm-windows"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "microsoft-ads"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "in": [
                          "standard-data-science-vm",
                          "windows-data-science-vm"
                        ]
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "batch"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "rendering-windows2016"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "center-for-internet-security-inc"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "cis-windows-server-201*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "pivotal"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "bosh-windows-server*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "cloud-infrastructure-services"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "ad*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "anyOf": [
                          {
                            "exists": "true",
                            "field": "Microsoft.Compute/virtualMachines/osProfile.windowsConfiguration"
                          },
                          {
                            "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                            "like": "Windows*"
                          }
                        ]
                      },
                      {
                        "anyOf": [
                          {
                            "exists": "false",
                            "field": "Microsoft.Compute/imageSKU"
                          },
                          {
                            "allOf": [
                              {
                                "notLike": "2008*",
                                "field": "Microsoft.Compute/imageSKU"
                              },
                              {
                                "notLike": "SQL2008*",
                                "field": "Microsoft.Compute/imageOffer"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.HybridCompute/machines"
              },
              {
                "field": "Microsoft.HybridCompute/imageOffer",
                "like": "windows*"
              }
            ]
          }
        ]
      }
    },
    "description": "This policy creates a Guest Configuration assignment to audit Windows virtual machines with non-compliant settings in Group Policy category: 'Security Options - Microsoft Network Client'. It also creates a system-assigned managed identity and deploys the VM extension for Guest Configuration. This policy should only be used along with its corresponding audit policy in an initiative. For more information on Guest Configuration policies, please visit https://aka.ms/gcpol",
    "mode": "Indexed"
  }
}
