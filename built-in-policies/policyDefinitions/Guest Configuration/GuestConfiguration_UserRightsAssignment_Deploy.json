{
  "id": "/providers/Microsoft.Authorization/policyDefinitions/815dcc9f-6662-43f2-9a03-1b83e9876f24",
  "name": "815dcc9f-6662-43f2-9a03-1b83e9876f24",
  "properties": {
    "policyType": "BuiltIn",
    "metadata": {
      "category": "Guest Configuration",
      "version": "1.0.0",
      "preview": true,
      "requiredProviders": [
        "Microsoft.GuestConfiguration"
      ]
    },
    "parameters": {
      "UsersOrGroupsThatMayTakeOwnershipOfFilesOrOtherObjects": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users and groups are permitted to take ownership of files, folders, registry keys, processes, or threads. This user right bypasses any permissions that are in place to protect objects to give ownership to the specified user.",
          "displayName": "Users or groups that may take ownership of files or other objects"
        },
        "defaultValue": "Administrators"
      },
      "UsersOrGroupsThatMayManageAuditingAndSecurityLog": {
        "type": "string",
        "metadata": {
          "description": "Specifies users and groups permitted to change the auditing options for files and directories and clear the Security log.",
          "displayName": "Users or groups that may manage auditing and security log"
        },
        "defaultValue": "Administrators"
      },
      "UsersOrGroupsThatMayCreateATokenObject": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users and groups are permitted to create an access token, which may provide elevated rights to access sensitive data.",
          "displayName": "Users or groups that may create a token object"
        },
        "defaultValue": "No One"
      },
      "UsersAndGroupsThatAreDeniedLocalLogon": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users and groups are explicitly not permitted to log on to the computer.",
          "displayName": "Users and groups that are denied local logon"
        },
        "defaultValue": "Guests"
      },
      "UsersOrGroupsThatMayLogOnThroughRemoteDesktopServices": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users or groups are permitted to log on as a Terminal Services client, Remote Desktop, or for Remote Assistance.",
          "displayName": "Users or groups that may log on through Remote Desktop Services"
        },
        "defaultValue": "Administrators, Remote Desktop Users"
      },
      "UsersAndGroupsThatMayRestoreFilesAndDirectories": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users and groups are permitted to bypass file, directory, registry, and other persistent object permissions when restoring backed up files and directories.",
          "displayName": "Users and groups that may restore files and directories"
        },
        "defaultValue": "Administrators, Backup Operators"
      },
      "UsersAndGroupsThatAreDeniedLoggingOnAsABatchJob": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users and groups are explicitly not permitted to log on to the computer as a batch job (i.e. scheduled task).",
          "displayName": "Users and groups that are denied logging on as a batch job"
        },
        "defaultValue": "Guests"
      },
      "UsersOrGroupsThatMayBackUpFilesAndDirectories": {
        "type": "string",
        "metadata": {
          "description": "Specifies users and groups allowed to circumvent file and directory permissions to back up the system.",
          "displayName": "Users or groups that may back up files and directories"
        },
        "defaultValue": "Administrators, Backup Operators"
      },
      "UsersAndGroupsThatAreDeniedLogOnThroughRemoteDesktopServices": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users and groups are explicitly not permitted to log on to the computer via Terminal Services/Remote Desktop Client.",
          "displayName": "Users and groups that are denied log on through Remote Desktop Services"
        },
        "defaultValue": "Guests"
      },
      "UserAndGroupsThatMayForceShutdownFromARemoteSystem": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users and groups are permitted to shut down the computer from a remote location on the network.",
          "displayName": "User and groups that may force shutdown from a remote system"
        },
        "defaultValue": "Administrators"
      },
      "UsersAndGroupsThatAreDeniedAccessToThisComputerFromTheNetwork": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users or groups are explicitly prohibited from connecting to the computer across the network.",
          "displayName": "Users and groups that are denied access to this computer from the network"
        },
        "defaultValue": "Guests"
      },
      "UsersOrGroupsThatMayChangeTheTimeZone": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users and groups are permitted to change the time zone of the computer.",
          "displayName": "Users or groups that may change the time zone"
        },
        "defaultValue": "Administrators, LOCAL SERVICE"
      },
      "UsersOrGroupsThatMayAccessThisComputerFromTheNetwork": {
        "type": "string",
        "metadata": {
          "description": "Specifies which remote users on the network are permitted to connect to the computer. This does not include Remote Desktop Connection.",
          "displayName": "Users or groups that may access this computer from the network"
        },
        "defaultValue": "Administrators, Authenticated Users"
      },
      "UsersOrGroupsThatMayLogOnLocally": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users or groups can interactively log on to the computer. Users who attempt to log on via Remote Desktop Connection or IIS also require this user right.",
          "displayName": "Users or groups that may log on locally"
        },
        "defaultValue": "Administrators"
      },
      "UsersAndGroupsThatAreDeniedLoggingOnAsAService": {
        "type": "string",
        "metadata": {
          "description": "Specifies which service accounts are explicitly not permitted to register a process as a service.",
          "displayName": "Users and groups that are denied logging on as a service"
        },
        "defaultValue": "Guests"
      },
      "UsersOrGroupsThatMayChangeTheSystemTime": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users and groups are permitted to change the time and date on the internal clock of the computer.",
          "displayName": "Users or groups that may change the system time"
        },
        "defaultValue": "Administrators, LOCAL SERVICE"
      },
      "UsersAndGroupsThatMayShutDownTheSystem": {
        "type": "string",
        "metadata": {
          "description": "Specifies which users and groups who are logged on locally to the computers in your environment are permitted to shut down the operating system with the Shut Down command.",
          "displayName": "Users and groups that may shut down the system"
        },
        "defaultValue": "Administrators"
      }
    },
    "displayName": "Deploy prerequisites to audit Windows VMs configurations in 'User Rights Assignment'",
    "policyRule": {
      "then": {
        "details": {
          "existenceCondition": {
            "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/parameterHash",
            "equals": "[base64(concat('Access this computer from the network;ExpectedValue', '=', parameters('UsersOrGroupsThatMayAccessThisComputerFromTheNetwork'), ',', 'Allow log on locally;ExpectedValue', '=', parameters('UsersOrGroupsThatMayLogOnLocally'), ',', 'Allow log on through Remote Desktop Services;ExpectedValue', '=', parameters('UsersOrGroupsThatMayLogOnThroughRemoteDesktopServices'), ',', 'Deny access to this computer from the network;ExpectedValue', '=', parameters('UsersAndGroupsThatAreDeniedAccessToThisComputerFromTheNetwork'), ',', 'Manage auditing and security log;ExpectedValue', '=', parameters('UsersOrGroupsThatMayManageAuditingAndSecurityLog'), ',', 'Back up files and directories;ExpectedValue', '=', parameters('UsersOrGroupsThatMayBackUpFilesAndDirectories'), ',', 'Change the system time;ExpectedValue', '=', parameters('UsersOrGroupsThatMayChangeTheSystemTime'), ',', 'Change the time zone;ExpectedValue', '=', parameters('UsersOrGroupsThatMayChangeTheTimeZone'), ',', 'Create a token object;ExpectedValue', '=', parameters('UsersOrGroupsThatMayCreateATokenObject'), ',', 'Deny log on as a batch job;ExpectedValue', '=', parameters('UsersAndGroupsThatAreDeniedLoggingOnAsABatchJob'), ',', 'Deny log on as a service;ExpectedValue', '=', parameters('UsersAndGroupsThatAreDeniedLoggingOnAsAService'), ',', 'Deny log on locally;ExpectedValue', '=', parameters('UsersAndGroupsThatAreDeniedLocalLogon'), ',', 'Deny log on through Remote Desktop Services;ExpectedValue', '=', parameters('UsersAndGroupsThatAreDeniedLogOnThroughRemoteDesktopServices'), ',', 'Force shutdown from a remote system;ExpectedValue', '=', parameters('UserAndGroupsThatMayForceShutdownFromARemoteSystem'), ',', 'Restore files and directories;ExpectedValue', '=', parameters('UsersAndGroupsThatMayRestoreFilesAndDirectories'), ',', 'Shut down the system;ExpectedValue', '=', parameters('UsersAndGroupsThatMayShutDownTheSystem'), ',', 'Take ownership of files or other objects;ExpectedValue', '=', parameters('UsersOrGroupsThatMayTakeOwnershipOfFilesOrOtherObjects')))]"
          },
          "type": "Microsoft.GuestConfiguration/guestConfigurationAssignments",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "name": "AzureBaseline_UserRightsAssignment",
          "deployment": {
            "properties": {
              "parameters": {
                "UsersAndGroupsThatAreDeniedAccessToThisComputerFromTheNetwork": {
                  "value": "[parameters('UsersAndGroupsThatAreDeniedAccessToThisComputerFromTheNetwork')]"
                },
                "UsersAndGroupsThatMayRestoreFilesAndDirectories": {
                  "value": "[parameters('UsersAndGroupsThatMayRestoreFilesAndDirectories')]"
                },
                "vmName": {
                  "value": "[field('name')]"
                },
                "UsersAndGroupsThatMayShutDownTheSystem": {
                  "value": "[parameters('UsersAndGroupsThatMayShutDownTheSystem')]"
                },
                "UsersOrGroupsThatMayCreateATokenObject": {
                  "value": "[parameters('UsersOrGroupsThatMayCreateATokenObject')]"
                },
                "UsersOrGroupsThatMayLogOnThroughRemoteDesktopServices": {
                  "value": "[parameters('UsersOrGroupsThatMayLogOnThroughRemoteDesktopServices')]"
                },
                "UsersOrGroupsThatMayChangeTheSystemTime": {
                  "value": "[parameters('UsersOrGroupsThatMayChangeTheSystemTime')]"
                },
                "UserAndGroupsThatMayForceShutdownFromARemoteSystem": {
                  "value": "[parameters('UserAndGroupsThatMayForceShutdownFromARemoteSystem')]"
                },
                "UsersAndGroupsThatAreDeniedLoggingOnAsABatchJob": {
                  "value": "[parameters('UsersAndGroupsThatAreDeniedLoggingOnAsABatchJob')]"
                },
                "UsersOrGroupsThatMayLogOnLocally": {
                  "value": "[parameters('UsersOrGroupsThatMayLogOnLocally')]"
                },
                "UsersOrGroupsThatMayChangeTheTimeZone": {
                  "value": "[parameters('UsersOrGroupsThatMayChangeTheTimeZone')]"
                },
                "UsersAndGroupsThatAreDeniedLogOnThroughRemoteDesktopServices": {
                  "value": "[parameters('UsersAndGroupsThatAreDeniedLogOnThroughRemoteDesktopServices')]"
                },
                "UsersOrGroupsThatMayBackUpFilesAndDirectories": {
                  "value": "[parameters('UsersOrGroupsThatMayBackUpFilesAndDirectories')]"
                },
                "location": {
                  "value": "[field('location')]"
                },
                "UsersOrGroupsThatMayTakeOwnershipOfFilesOrOtherObjects": {
                  "value": "[parameters('UsersOrGroupsThatMayTakeOwnershipOfFilesOrOtherObjects')]"
                },
                "configurationName": {
                  "value": "AzureBaseline_UserRightsAssignment"
                },
                "UsersAndGroupsThatAreDeniedLocalLogon": {
                  "value": "[parameters('UsersAndGroupsThatAreDeniedLocalLogon')]"
                },
                "UsersOrGroupsThatMayManageAuditingAndSecurityLog": {
                  "value": "[parameters('UsersOrGroupsThatMayManageAuditingAndSecurityLog')]"
                },
                "UsersOrGroupsThatMayAccessThisComputerFromTheNetwork": {
                  "value": "[parameters('UsersOrGroupsThatMayAccessThisComputerFromTheNetwork')]"
                },
                "type": {
                  "value": "[field('type')]"
                },
                "UsersAndGroupsThatAreDeniedLoggingOnAsAService": {
                  "value": "[parameters('UsersAndGroupsThatAreDeniedLoggingOnAsAService')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "parameters": {
                  "UsersAndGroupsThatAreDeniedAccessToThisComputerFromTheNetwork": {
                    "type": "string"
                  },
                  "UsersAndGroupsThatMayRestoreFilesAndDirectories": {
                    "type": "string"
                  },
                  "vmName": {
                    "type": "string"
                  },
                  "UsersAndGroupsThatMayShutDownTheSystem": {
                    "type": "string"
                  },
                  "UsersOrGroupsThatMayCreateATokenObject": {
                    "type": "string"
                  },
                  "UsersOrGroupsThatMayLogOnThroughRemoteDesktopServices": {
                    "type": "string"
                  },
                  "UsersOrGroupsThatMayChangeTheSystemTime": {
                    "type": "string"
                  },
                  "UserAndGroupsThatMayForceShutdownFromARemoteSystem": {
                    "type": "string"
                  },
                  "UsersAndGroupsThatAreDeniedLoggingOnAsABatchJob": {
                    "type": "string"
                  },
                  "UsersOrGroupsThatMayLogOnLocally": {
                    "type": "string"
                  },
                  "UsersOrGroupsThatMayChangeTheTimeZone": {
                    "type": "string"
                  },
                  "UsersAndGroupsThatAreDeniedLogOnThroughRemoteDesktopServices": {
                    "type": "string"
                  },
                  "UsersOrGroupsThatMayBackUpFilesAndDirectories": {
                    "type": "string"
                  },
                  "location": {
                    "type": "string"
                  },
                  "UsersOrGroupsThatMayTakeOwnershipOfFilesOrOtherObjects": {
                    "type": "string"
                  },
                  "configurationName": {
                    "type": "string"
                  },
                  "UsersAndGroupsThatAreDeniedLocalLogon": {
                    "type": "string"
                  },
                  "UsersOrGroupsThatMayManageAuditingAndSecurityLog": {
                    "type": "string"
                  },
                  "UsersOrGroupsThatMayAccessThisComputerFromTheNetwork": {
                    "type": "string"
                  },
                  "type": {
                    "type": "string"
                  },
                  "UsersAndGroupsThatAreDeniedLoggingOnAsAService": {
                    "type": "string"
                  }
                },
                "contentVersion": "1.0.0.0",
                "resources": [
                  {
                    "properties": {
                      "guestConfiguration": {
                        "version": "1.*",
                        "configurationParameter": [
                          {
                            "value": "[parameters('UsersOrGroupsThatMayAccessThisComputerFromTheNetwork')]",
                            "name": "Access this computer from the network;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayLogOnLocally')]",
                            "name": "Allow log on locally;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayLogOnThroughRemoteDesktopServices')]",
                            "name": "Allow log on through Remote Desktop Services;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatAreDeniedAccessToThisComputerFromTheNetwork')]",
                            "name": "Deny access to this computer from the network;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayManageAuditingAndSecurityLog')]",
                            "name": "Manage auditing and security log;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayBackUpFilesAndDirectories')]",
                            "name": "Back up files and directories;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayChangeTheSystemTime')]",
                            "name": "Change the system time;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayChangeTheTimeZone')]",
                            "name": "Change the time zone;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayCreateATokenObject')]",
                            "name": "Create a token object;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatAreDeniedLoggingOnAsABatchJob')]",
                            "name": "Deny log on as a batch job;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatAreDeniedLoggingOnAsAService')]",
                            "name": "Deny log on as a service;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatAreDeniedLocalLogon')]",
                            "name": "Deny log on locally;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatAreDeniedLogOnThroughRemoteDesktopServices')]",
                            "name": "Deny log on through Remote Desktop Services;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UserAndGroupsThatMayForceShutdownFromARemoteSystem')]",
                            "name": "Force shutdown from a remote system;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatMayRestoreFilesAndDirectories')]",
                            "name": "Restore files and directories;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatMayShutDownTheSystem')]",
                            "name": "Shut down the system;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayTakeOwnershipOfFilesOrOtherObjects')]",
                            "name": "Take ownership of files or other objects;ExpectedValue"
                          }
                        ],
                        "name": "[parameters('configurationName')]"
                      }
                    },
                    "name": "[concat(parameters('vmName'), '/Microsoft.GuestConfiguration/', parameters('configurationName'))]",
                    "location": "[parameters('location')]",
                    "condition": "[equals(toLower(parameters('type')), toLower('microsoft.hybridcompute/machines'))]",
                    "apiVersion": "2018-11-20",
                    "type": "Microsoft.HybridCompute/machines/providers/guestConfigurationAssignments"
                  },
                  {
                    "properties": {
                      "guestConfiguration": {
                        "version": "1.*",
                        "configurationParameter": [
                          {
                            "value": "[parameters('UsersOrGroupsThatMayAccessThisComputerFromTheNetwork')]",
                            "name": "Access this computer from the network;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayLogOnLocally')]",
                            "name": "Allow log on locally;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayLogOnThroughRemoteDesktopServices')]",
                            "name": "Allow log on through Remote Desktop Services;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatAreDeniedAccessToThisComputerFromTheNetwork')]",
                            "name": "Deny access to this computer from the network;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayManageAuditingAndSecurityLog')]",
                            "name": "Manage auditing and security log;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayBackUpFilesAndDirectories')]",
                            "name": "Back up files and directories;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayChangeTheSystemTime')]",
                            "name": "Change the system time;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayChangeTheTimeZone')]",
                            "name": "Change the time zone;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayCreateATokenObject')]",
                            "name": "Create a token object;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatAreDeniedLoggingOnAsABatchJob')]",
                            "name": "Deny log on as a batch job;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatAreDeniedLoggingOnAsAService')]",
                            "name": "Deny log on as a service;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatAreDeniedLocalLogon')]",
                            "name": "Deny log on locally;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatAreDeniedLogOnThroughRemoteDesktopServices')]",
                            "name": "Deny log on through Remote Desktop Services;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UserAndGroupsThatMayForceShutdownFromARemoteSystem')]",
                            "name": "Force shutdown from a remote system;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatMayRestoreFilesAndDirectories')]",
                            "name": "Restore files and directories;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersAndGroupsThatMayShutDownTheSystem')]",
                            "name": "Shut down the system;ExpectedValue"
                          },
                          {
                            "value": "[parameters('UsersOrGroupsThatMayTakeOwnershipOfFilesOrOtherObjects')]",
                            "name": "Take ownership of files or other objects;ExpectedValue"
                          }
                        ],
                        "name": "[parameters('configurationName')]"
                      }
                    },
                    "name": "[concat(parameters('vmName'), '/Microsoft.GuestConfiguration/', parameters('configurationName'))]",
                    "location": "[parameters('location')]",
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2018-11-20",
                    "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments"
                  },
                  {
                    "name": "[parameters('vmName')]",
                    "location": "[parameters('location')]",
                    "identity": {
                      "type": "SystemAssigned"
                    },
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2017-03-30",
                    "type": "Microsoft.Compute/virtualMachines"
                  },
                  {
                    "properties": {
                      "autoUpgradeMinorVersion": true,
                      "settings": {},
                      "publisher": "Microsoft.GuestConfiguration",
                      "protectedSettings": {},
                      "typeHandlerVersion": "1.1",
                      "type": "ConfigurationforWindows"
                    },
                    "name": "[concat(parameters('vmName'), '/AzurePolicyforWindows')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                      "[concat('Microsoft.Compute/virtualMachines/',parameters('vmName'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',parameters('configurationName'))]"
                    ],
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2015-05-01-preview",
                    "type": "Microsoft.Compute/virtualMachines/extensions"
                  }
                ]
              },
              "mode": "incremental"
            }
          }
        },
        "effect": "deployIfNotExists"
      },
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Compute/virtualMachines"
              },
              {
                "anyOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "in": [
                      "esri",
                      "incredibuild",
                      "MicrosoftDynamicsAX",
                      "MicrosoftSharepoint",
                      "MicrosoftVisualStudio",
                      "MicrosoftWindowsDesktop",
                      "MicrosoftWindowsServerHPCPack"
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "MicrosoftWindowsServer"
                      },
                      {
                        "notLike": "2008*",
                        "field": "Microsoft.Compute/imageSKU"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "MicrosoftSQLServer"
                      },
                      {
                        "notLike": "SQL2008*",
                        "field": "Microsoft.Compute/imageOffer"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "microsoft-dsvm"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "dsvm-windows"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "microsoft-ads"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "in": [
                          "standard-data-science-vm",
                          "windows-data-science-vm"
                        ]
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "batch"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "rendering-windows2016"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "center-for-internet-security-inc"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "cis-windows-server-201*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "pivotal"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "bosh-windows-server*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "cloud-infrastructure-services"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "ad*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "anyOf": [
                          {
                            "exists": "true",
                            "field": "Microsoft.Compute/virtualMachines/osProfile.windowsConfiguration"
                          },
                          {
                            "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                            "like": "Windows*"
                          }
                        ]
                      },
                      {
                        "anyOf": [
                          {
                            "exists": "false",
                            "field": "Microsoft.Compute/imageSKU"
                          },
                          {
                            "allOf": [
                              {
                                "notLike": "2008*",
                                "field": "Microsoft.Compute/imageSKU"
                              },
                              {
                                "notLike": "SQL2008*",
                                "field": "Microsoft.Compute/imageOffer"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.HybridCompute/machines"
              },
              {
                "field": "Microsoft.HybridCompute/imageOffer",
                "like": "windows*"
              }
            ]
          }
        ]
      }
    },
    "description": "This policy creates a Guest Configuration assignment to audit Windows virtual machines with non-compliant settings in Group Policy category: 'User Rights Assignment'. It also creates a system-assigned managed identity and deploys the VM extension for Guest Configuration. This policy should only be used along with its corresponding audit policy in an initiative. For more information on Guest Configuration policies, please visit https://aka.ms/gcpol",
    "mode": "Indexed"
  }
}
