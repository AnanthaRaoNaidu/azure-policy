{
  "id": "/providers/Microsoft.Authorization/policyDefinitions/7040a231-fb65-4412-8c0a-b365f4866c24",
  "name": "7040a231-fb65-4412-8c0a-b365f4866c24",
  "properties": {
    "policyType": "BuiltIn",
    "metadata": {
      "category": "Guest Configuration",
      "version": "1.0.0",
      "preview": true,
      "requiredProviders": [
        "Microsoft.GuestConfiguration"
      ]
    },
    "parameters": {
      "AllowUnencryptedTraffic": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether the Windows Remote Management (WinRM) service sends and receives unencrypted messages over the network.",
          "displayName": "Allow unencrypted traffic"
        },
        "defaultValue": "0"
      },
      "SpecifyTheIntervalToCheckForDefinitionUpdates": {
        "type": "string",
        "metadata": {
          "description": "Specifies an interval at which to check for Windows Defender definition updates. The time value is represented as the number of hours between update checks.",
          "displayName": "Specify the interval to check for definition updates"
        },
        "defaultValue": "8"
      },
      "ConfigureWindowsSmartScreen": {
        "type": "string",
        "metadata": {
          "description": "Specifies how to manage the behavior of Windows SmartScreen. Windows SmartScreen helps keep PCs safer by warning users before running unrecognized programs downloaded from the Internet. Some information is sent to Microsoft about files and programs run on PCs with this feature enabled.",
          "displayName": "Configure Windows SmartScreen"
        },
        "defaultValue": "1"
      },
      "SetTheDefaultBehaviorForAutoRun": {
        "type": "string",
        "metadata": {
          "description": "Specifies the default behavior for Autorun commands. Autorun commands are generally stored in autorun.inf files. They often launch the installation program or other routines.",
          "displayName": "Set the default behavior for AutoRun"
        },
        "defaultValue": "1"
      },
      "DisallowDigestAuthentication": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether the Windows Remote Management (WinRM) client will not use Digest authentication.",
          "displayName": "Disallow Digest authentication"
        },
        "defaultValue": "0"
      },
      "AutomaticallySendMemoryDumpsForOSgeneratedErrorReports": {
        "type": "string",
        "metadata": {
          "description": "Specifies if memory dumps in support of OS-generated error reports can be sent to Microsoft automatically.",
          "displayName": "Automatically send memory dumps for OS-generated error reports"
        },
        "defaultValue": "1"
      },
      "TurnOffDataExecutionPreventionForExplorer": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether to turn off Data Execution Prevention for Windows File Explorer. Disabling data execution prevention can allow certain legacy plug-in applications to function without terminating Explorer.",
          "displayName": "Turn off Data Execution Prevention for Explorer"
        },
        "defaultValue": "0"
      },
      "DisallowWinRMFromStoringRunAsCredentials": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether the Windows Remote Management (WinRM) service will not allow RunAs credentials to be stored for any plug-ins.",
          "displayName": "Disallow WinRM from storing RunAs credentials"
        },
        "defaultValue": "1"
      },
      "AllowTelemetry": {
        "type": "string",
        "metadata": {
          "description": "Specifies configuration of the amount of diagnostic and usage data reported to Microsoft. The data is transmitted securely and sensitive data is not sent.",
          "displayName": "Allow Telemetry"
        },
        "defaultValue": "2"
      },
      "SetupSpecifyTheMaximumLogFileSizeKB": {
        "type": "string",
        "metadata": {
          "description": "Specifies the maximum size for the Setup event log in kilobytes.",
          "displayName": "Setup: Specify the maximum log file size (KB)"
        },
        "defaultValue": "32768"
      },
      "DoNotAllowPasswordsToBeSaved": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether to prevent Remote Desktop Services - Terminal Services clients from saving passwords on a computer.",
          "displayName": "Do not allow passwords to be saved"
        },
        "defaultValue": "1"
      },
      "SystemSpecifyTheMaximumLogFileSizeKB": {
        "type": "string",
        "metadata": {
          "description": "Specifies the maximum size for the System event log in kilobytes.",
          "displayName": "System: Specify the maximum log file size (KB)"
        },
        "defaultValue": "32768"
      },
      "SetClientConnectionEncryptionLevel": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether to require the use of a specific encryption level to secure communications between client computers and RD Session Host servers during Remote Desktop Protocol (RDP) connections. This policy only applies when you are using native RDP encryption.",
          "displayName": "Set client connection encryption level"
        },
        "defaultValue": "3"
      },
      "ApplicationSpecifyTheMaximumLogFileSizeKB": {
        "type": "string",
        "metadata": {
          "description": "Specifies the maximum size for the Application event log in kilobytes.",
          "displayName": "Application: Specify the maximum log file size (KB)"
        },
        "defaultValue": "32768"
      },
      "SecuritySpecifyTheMaximumLogFileSizeKB": {
        "type": "string",
        "metadata": {
          "description": "Specifies the maximum size for the Security event log in kilobytes.",
          "displayName": "Security: Specify the maximum log file size (KB)"
        },
        "defaultValue": "196608"
      },
      "SendFileSamplesWhenFurtherAnalysisIsRequired": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether and how Windows Defender will submit samples of suspected malware  to Microsoft for further analysis when opt-in for MAPS telemetry is set.",
          "displayName": "Send file samples when further analysis is required"
        },
        "defaultValue": "1"
      },
      "AlwaysPromptForPasswordUponConnection": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether Terminal Services/Remote Desktop Connection always prompts the client computer for a password upon connection.",
          "displayName": "Always prompt for password upon connection"
        },
        "defaultValue": "1"
      },
      "AlwaysInstallWithElevatedPrivileges": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether Windows Installer should use system permissions when it installs any program on the system.",
          "displayName": "Always install with elevated privileges"
        },
        "defaultValue": "0"
      },
      "AllowIndexingOfEncryptedFiles": {
        "type": "string",
        "metadata": {
          "description": "Specifies whether encrypted items are allowed to be indexed.",
          "displayName": "Allow indexing of encrypted files"
        },
        "defaultValue": "0"
      },
      "ConfigureDefaultConsent": {
        "type": "string",
        "metadata": {
          "description": "Specifies setting of the default consent handling for error reports sent to Microsoft.",
          "displayName": "Configure Default consent"
        },
        "defaultValue": "4"
      }
    },
    "displayName": "Deploy prerequisites to audit Windows VMs configurations in 'Windows Components'",
    "policyRule": {
      "then": {
        "details": {
          "existenceCondition": {
            "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/parameterHash",
            "equals": "[base64(concat('Send file samples when further analysis is required;ExpectedValue', '=', parameters('SendFileSamplesWhenFurtherAnalysisIsRequired'), ',', 'Allow indexing of encrypted files;ExpectedValue', '=', parameters('AllowIndexingOfEncryptedFiles'), ',', 'Allow Telemetry;ExpectedValue', '=', parameters('AllowTelemetry'), ',', 'Allow unencrypted traffic;ExpectedValue', '=', parameters('AllowUnencryptedTraffic'), ',', 'Always install with elevated privileges;ExpectedValue', '=', parameters('AlwaysInstallWithElevatedPrivileges'), ',', 'Always prompt for password upon connection;ExpectedValue', '=', parameters('AlwaysPromptForPasswordUponConnection'), ',', 'Application: Specify the maximum log file size (KB);ExpectedValue', '=', parameters('ApplicationSpecifyTheMaximumLogFileSizeKB'), ',', 'Automatically send memory dumps for OS-generated error reports;ExpectedValue', '=', parameters('AutomaticallySendMemoryDumpsForOSgeneratedErrorReports'), ',', 'Configure Default consent;ExpectedValue', '=', parameters('ConfigureDefaultConsent'), ',', 'Configure Windows SmartScreen;ExpectedValue', '=', parameters('ConfigureWindowsSmartScreen'), ',', 'Disallow Digest authentication;ExpectedValue', '=', parameters('DisallowDigestAuthentication'), ',', 'Disallow WinRM from storing RunAs credentials;ExpectedValue', '=', parameters('DisallowWinRMFromStoringRunAsCredentials'), ',', 'Do not allow passwords to be saved;ExpectedValue', '=', parameters('DoNotAllowPasswordsToBeSaved'), ',', 'Security: Specify the maximum log file size (KB);ExpectedValue', '=', parameters('SecuritySpecifyTheMaximumLogFileSizeKB'), ',', 'Set client connection encryption level;ExpectedValue', '=', parameters('SetClientConnectionEncryptionLevel'), ',', 'Set the default behavior for AutoRun;ExpectedValue', '=', parameters('SetTheDefaultBehaviorForAutoRun'), ',', 'Setup: Specify the maximum log file size (KB);ExpectedValue', '=', parameters('SetupSpecifyTheMaximumLogFileSizeKB'), ',', 'System: Specify the maximum log file size (KB);ExpectedValue', '=', parameters('SystemSpecifyTheMaximumLogFileSizeKB'), ',', 'Turn off Data Execution Prevention for Explorer;ExpectedValue', '=', parameters('TurnOffDataExecutionPreventionForExplorer'), ',', 'Specify the interval to check for definition updates;ExpectedValue', '=', parameters('SpecifyTheIntervalToCheckForDefinitionUpdates')))]"
          },
          "type": "Microsoft.GuestConfiguration/guestConfigurationAssignments",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "name": "AzureBaseline_WindowsComponents",
          "deployment": {
            "properties": {
              "parameters": {
                "ConfigureWindowsSmartScreen": {
                  "value": "[parameters('ConfigureWindowsSmartScreen')]"
                },
                "SetTheDefaultBehaviorForAutoRun": {
                  "value": "[parameters('SetTheDefaultBehaviorForAutoRun')]"
                },
                "SendFileSamplesWhenFurtherAnalysisIsRequired": {
                  "value": "[parameters('SendFileSamplesWhenFurtherAnalysisIsRequired')]"
                },
                "AlwaysPromptForPasswordUponConnection": {
                  "value": "[parameters('AlwaysPromptForPasswordUponConnection')]"
                },
                "AlwaysInstallWithElevatedPrivileges": {
                  "value": "[parameters('AlwaysInstallWithElevatedPrivileges')]"
                },
                "ConfigureDefaultConsent": {
                  "value": "[parameters('ConfigureDefaultConsent')]"
                },
                "type": {
                  "value": "[field('type')]"
                },
                "SetupSpecifyTheMaximumLogFileSizeKB": {
                  "value": "[parameters('SetupSpecifyTheMaximumLogFileSizeKB')]"
                },
                "configurationName": {
                  "value": "AzureBaseline_WindowsComponents"
                },
                "SystemSpecifyTheMaximumLogFileSizeKB": {
                  "value": "[parameters('SystemSpecifyTheMaximumLogFileSizeKB')]"
                },
                "SecuritySpecifyTheMaximumLogFileSizeKB": {
                  "value": "[parameters('SecuritySpecifyTheMaximumLogFileSizeKB')]"
                },
                "DisallowWinRMFromStoringRunAsCredentials": {
                  "value": "[parameters('DisallowWinRMFromStoringRunAsCredentials')]"
                },
                "AllowTelemetry": {
                  "value": "[parameters('AllowTelemetry')]"
                },
                "DoNotAllowPasswordsToBeSaved": {
                  "value": "[parameters('DoNotAllowPasswordsToBeSaved')]"
                },
                "AutomaticallySendMemoryDumpsForOSgeneratedErrorReports": {
                  "value": "[parameters('AutomaticallySendMemoryDumpsForOSgeneratedErrorReports')]"
                },
                "location": {
                  "value": "[field('location')]"
                },
                "AllowIndexingOfEncryptedFiles": {
                  "value": "[parameters('AllowIndexingOfEncryptedFiles')]"
                },
                "AllowUnencryptedTraffic": {
                  "value": "[parameters('AllowUnencryptedTraffic')]"
                },
                "TurnOffDataExecutionPreventionForExplorer": {
                  "value": "[parameters('TurnOffDataExecutionPreventionForExplorer')]"
                },
                "ApplicationSpecifyTheMaximumLogFileSizeKB": {
                  "value": "[parameters('ApplicationSpecifyTheMaximumLogFileSizeKB')]"
                },
                "SetClientConnectionEncryptionLevel": {
                  "value": "[parameters('SetClientConnectionEncryptionLevel')]"
                },
                "DisallowDigestAuthentication": {
                  "value": "[parameters('DisallowDigestAuthentication')]"
                },
                "SpecifyTheIntervalToCheckForDefinitionUpdates": {
                  "value": "[parameters('SpecifyTheIntervalToCheckForDefinitionUpdates')]"
                },
                "vmName": {
                  "value": "[field('name')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "parameters": {
                  "ConfigureWindowsSmartScreen": {
                    "type": "string"
                  },
                  "SetTheDefaultBehaviorForAutoRun": {
                    "type": "string"
                  },
                  "SendFileSamplesWhenFurtherAnalysisIsRequired": {
                    "type": "string"
                  },
                  "AlwaysPromptForPasswordUponConnection": {
                    "type": "string"
                  },
                  "AlwaysInstallWithElevatedPrivileges": {
                    "type": "string"
                  },
                  "ConfigureDefaultConsent": {
                    "type": "string"
                  },
                  "type": {
                    "type": "string"
                  },
                  "SetupSpecifyTheMaximumLogFileSizeKB": {
                    "type": "string"
                  },
                  "configurationName": {
                    "type": "string"
                  },
                  "SystemSpecifyTheMaximumLogFileSizeKB": {
                    "type": "string"
                  },
                  "SecuritySpecifyTheMaximumLogFileSizeKB": {
                    "type": "string"
                  },
                  "DisallowWinRMFromStoringRunAsCredentials": {
                    "type": "string"
                  },
                  "AllowTelemetry": {
                    "type": "string"
                  },
                  "DoNotAllowPasswordsToBeSaved": {
                    "type": "string"
                  },
                  "AutomaticallySendMemoryDumpsForOSgeneratedErrorReports": {
                    "type": "string"
                  },
                  "location": {
                    "type": "string"
                  },
                  "AllowIndexingOfEncryptedFiles": {
                    "type": "string"
                  },
                  "AllowUnencryptedTraffic": {
                    "type": "string"
                  },
                  "TurnOffDataExecutionPreventionForExplorer": {
                    "type": "string"
                  },
                  "ApplicationSpecifyTheMaximumLogFileSizeKB": {
                    "type": "string"
                  },
                  "SetClientConnectionEncryptionLevel": {
                    "type": "string"
                  },
                  "DisallowDigestAuthentication": {
                    "type": "string"
                  },
                  "SpecifyTheIntervalToCheckForDefinitionUpdates": {
                    "type": "string"
                  },
                  "vmName": {
                    "type": "string"
                  }
                },
                "contentVersion": "1.0.0.0",
                "resources": [
                  {
                    "properties": {
                      "guestConfiguration": {
                        "version": "1.*",
                        "configurationParameter": [
                          {
                            "value": "[parameters('SendFileSamplesWhenFurtherAnalysisIsRequired')]",
                            "name": "Send file samples when further analysis is required;ExpectedValue"
                          },
                          {
                            "value": "[parameters('AllowIndexingOfEncryptedFiles')]",
                            "name": "Allow indexing of encrypted files;ExpectedValue"
                          },
                          {
                            "value": "[parameters('AllowTelemetry')]",
                            "name": "Allow Telemetry;ExpectedValue"
                          },
                          {
                            "value": "[parameters('AllowUnencryptedTraffic')]",
                            "name": "Allow unencrypted traffic;ExpectedValue"
                          },
                          {
                            "value": "[parameters('AlwaysInstallWithElevatedPrivileges')]",
                            "name": "Always install with elevated privileges;ExpectedValue"
                          },
                          {
                            "value": "[parameters('AlwaysPromptForPasswordUponConnection')]",
                            "name": "Always prompt for password upon connection;ExpectedValue"
                          },
                          {
                            "value": "[parameters('ApplicationSpecifyTheMaximumLogFileSizeKB')]",
                            "name": "Application: Specify the maximum log file size (KB);ExpectedValue"
                          },
                          {
                            "value": "[parameters('AutomaticallySendMemoryDumpsForOSgeneratedErrorReports')]",
                            "name": "Automatically send memory dumps for OS-generated error reports;ExpectedValue"
                          },
                          {
                            "value": "[parameters('ConfigureDefaultConsent')]",
                            "name": "Configure Default consent;ExpectedValue"
                          },
                          {
                            "value": "[parameters('ConfigureWindowsSmartScreen')]",
                            "name": "Configure Windows SmartScreen;ExpectedValue"
                          },
                          {
                            "value": "[parameters('DisallowDigestAuthentication')]",
                            "name": "Disallow Digest authentication;ExpectedValue"
                          },
                          {
                            "value": "[parameters('DisallowWinRMFromStoringRunAsCredentials')]",
                            "name": "Disallow WinRM from storing RunAs credentials;ExpectedValue"
                          },
                          {
                            "value": "[parameters('DoNotAllowPasswordsToBeSaved')]",
                            "name": "Do not allow passwords to be saved;ExpectedValue"
                          },
                          {
                            "value": "[parameters('SecuritySpecifyTheMaximumLogFileSizeKB')]",
                            "name": "Security: Specify the maximum log file size (KB);ExpectedValue"
                          },
                          {
                            "value": "[parameters('SetClientConnectionEncryptionLevel')]",
                            "name": "Set client connection encryption level;ExpectedValue"
                          },
                          {
                            "value": "[parameters('SetTheDefaultBehaviorForAutoRun')]",
                            "name": "Set the default behavior for AutoRun;ExpectedValue"
                          },
                          {
                            "value": "[parameters('SetupSpecifyTheMaximumLogFileSizeKB')]",
                            "name": "Setup: Specify the maximum log file size (KB);ExpectedValue"
                          },
                          {
                            "value": "[parameters('SystemSpecifyTheMaximumLogFileSizeKB')]",
                            "name": "System: Specify the maximum log file size (KB);ExpectedValue"
                          },
                          {
                            "value": "[parameters('TurnOffDataExecutionPreventionForExplorer')]",
                            "name": "Turn off Data Execution Prevention for Explorer;ExpectedValue"
                          },
                          {
                            "value": "[parameters('SpecifyTheIntervalToCheckForDefinitionUpdates')]",
                            "name": "Specify the interval to check for definition updates;ExpectedValue"
                          }
                        ],
                        "name": "[parameters('configurationName')]"
                      }
                    },
                    "name": "[concat(parameters('vmName'), '/Microsoft.GuestConfiguration/', parameters('configurationName'))]",
                    "location": "[parameters('location')]",
                    "condition": "[equals(toLower(parameters('type')), toLower('microsoft.hybridcompute/machines'))]",
                    "apiVersion": "2018-11-20",
                    "type": "Microsoft.HybridCompute/machines/providers/guestConfigurationAssignments"
                  },
                  {
                    "properties": {
                      "guestConfiguration": {
                        "version": "1.*",
                        "configurationParameter": [
                          {
                            "value": "[parameters('SendFileSamplesWhenFurtherAnalysisIsRequired')]",
                            "name": "Send file samples when further analysis is required;ExpectedValue"
                          },
                          {
                            "value": "[parameters('AllowIndexingOfEncryptedFiles')]",
                            "name": "Allow indexing of encrypted files;ExpectedValue"
                          },
                          {
                            "value": "[parameters('AllowTelemetry')]",
                            "name": "Allow Telemetry;ExpectedValue"
                          },
                          {
                            "value": "[parameters('AllowUnencryptedTraffic')]",
                            "name": "Allow unencrypted traffic;ExpectedValue"
                          },
                          {
                            "value": "[parameters('AlwaysInstallWithElevatedPrivileges')]",
                            "name": "Always install with elevated privileges;ExpectedValue"
                          },
                          {
                            "value": "[parameters('AlwaysPromptForPasswordUponConnection')]",
                            "name": "Always prompt for password upon connection;ExpectedValue"
                          },
                          {
                            "value": "[parameters('ApplicationSpecifyTheMaximumLogFileSizeKB')]",
                            "name": "Application: Specify the maximum log file size (KB);ExpectedValue"
                          },
                          {
                            "value": "[parameters('AutomaticallySendMemoryDumpsForOSgeneratedErrorReports')]",
                            "name": "Automatically send memory dumps for OS-generated error reports;ExpectedValue"
                          },
                          {
                            "value": "[parameters('ConfigureDefaultConsent')]",
                            "name": "Configure Default consent;ExpectedValue"
                          },
                          {
                            "value": "[parameters('ConfigureWindowsSmartScreen')]",
                            "name": "Configure Windows SmartScreen;ExpectedValue"
                          },
                          {
                            "value": "[parameters('DisallowDigestAuthentication')]",
                            "name": "Disallow Digest authentication;ExpectedValue"
                          },
                          {
                            "value": "[parameters('DisallowWinRMFromStoringRunAsCredentials')]",
                            "name": "Disallow WinRM from storing RunAs credentials;ExpectedValue"
                          },
                          {
                            "value": "[parameters('DoNotAllowPasswordsToBeSaved')]",
                            "name": "Do not allow passwords to be saved;ExpectedValue"
                          },
                          {
                            "value": "[parameters('SecuritySpecifyTheMaximumLogFileSizeKB')]",
                            "name": "Security: Specify the maximum log file size (KB);ExpectedValue"
                          },
                          {
                            "value": "[parameters('SetClientConnectionEncryptionLevel')]",
                            "name": "Set client connection encryption level;ExpectedValue"
                          },
                          {
                            "value": "[parameters('SetTheDefaultBehaviorForAutoRun')]",
                            "name": "Set the default behavior for AutoRun;ExpectedValue"
                          },
                          {
                            "value": "[parameters('SetupSpecifyTheMaximumLogFileSizeKB')]",
                            "name": "Setup: Specify the maximum log file size (KB);ExpectedValue"
                          },
                          {
                            "value": "[parameters('SystemSpecifyTheMaximumLogFileSizeKB')]",
                            "name": "System: Specify the maximum log file size (KB);ExpectedValue"
                          },
                          {
                            "value": "[parameters('TurnOffDataExecutionPreventionForExplorer')]",
                            "name": "Turn off Data Execution Prevention for Explorer;ExpectedValue"
                          },
                          {
                            "value": "[parameters('SpecifyTheIntervalToCheckForDefinitionUpdates')]",
                            "name": "Specify the interval to check for definition updates;ExpectedValue"
                          }
                        ],
                        "name": "[parameters('configurationName')]"
                      }
                    },
                    "name": "[concat(parameters('vmName'), '/Microsoft.GuestConfiguration/', parameters('configurationName'))]",
                    "location": "[parameters('location')]",
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2018-11-20",
                    "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments"
                  },
                  {
                    "name": "[parameters('vmName')]",
                    "location": "[parameters('location')]",
                    "identity": {
                      "type": "SystemAssigned"
                    },
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2017-03-30",
                    "type": "Microsoft.Compute/virtualMachines"
                  },
                  {
                    "properties": {
                      "autoUpgradeMinorVersion": true,
                      "settings": {},
                      "publisher": "Microsoft.GuestConfiguration",
                      "protectedSettings": {},
                      "typeHandlerVersion": "1.1",
                      "type": "ConfigurationforWindows"
                    },
                    "name": "[concat(parameters('vmName'), '/AzurePolicyforWindows')]",
                    "location": "[parameters('location')]",
                    "dependsOn": [
                      "[concat('Microsoft.Compute/virtualMachines/',parameters('vmName'),'/providers/Microsoft.GuestConfiguration/guestConfigurationAssignments/',parameters('configurationName'))]"
                    ],
                    "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                    "apiVersion": "2015-05-01-preview",
                    "type": "Microsoft.Compute/virtualMachines/extensions"
                  }
                ]
              },
              "mode": "incremental"
            }
          }
        },
        "effect": "deployIfNotExists"
      },
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Compute/virtualMachines"
              },
              {
                "anyOf": [
                  {
                    "field": "Microsoft.Compute/imagePublisher",
                    "in": [
                      "esri",
                      "incredibuild",
                      "MicrosoftDynamicsAX",
                      "MicrosoftSharepoint",
                      "MicrosoftVisualStudio",
                      "MicrosoftWindowsDesktop",
                      "MicrosoftWindowsServerHPCPack"
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "MicrosoftWindowsServer"
                      },
                      {
                        "notLike": "2008*",
                        "field": "Microsoft.Compute/imageSKU"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "MicrosoftSQLServer"
                      },
                      {
                        "notLike": "SQL2008*",
                        "field": "Microsoft.Compute/imageOffer"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "microsoft-dsvm"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "dsvm-windows"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "microsoft-ads"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "in": [
                          "standard-data-science-vm",
                          "windows-data-science-vm"
                        ]
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "batch"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "equals": "rendering-windows2016"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "center-for-internet-security-inc"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "cis-windows-server-201*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "pivotal"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "bosh-windows-server*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "equals": "cloud-infrastructure-services"
                      },
                      {
                        "field": "Microsoft.Compute/imageOffer",
                        "like": "ad*"
                      }
                    ]
                  },
                  {
                    "allOf": [
                      {
                        "anyOf": [
                          {
                            "exists": "true",
                            "field": "Microsoft.Compute/virtualMachines/osProfile.windowsConfiguration"
                          },
                          {
                            "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                            "like": "Windows*"
                          }
                        ]
                      },
                      {
                        "anyOf": [
                          {
                            "exists": "false",
                            "field": "Microsoft.Compute/imageSKU"
                          },
                          {
                            "allOf": [
                              {
                                "notLike": "2008*",
                                "field": "Microsoft.Compute/imageSKU"
                              },
                              {
                                "notLike": "SQL2008*",
                                "field": "Microsoft.Compute/imageOffer"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.HybridCompute/machines"
              },
              {
                "field": "Microsoft.HybridCompute/imageOffer",
                "like": "windows*"
              }
            ]
          }
        ]
      }
    },
    "description": "This policy creates a Guest Configuration assignment to audit Windows virtual machines with non-compliant settings in Group Policy category: 'Windows Components'. It also creates a system-assigned managed identity and deploys the VM extension for Guest Configuration. This policy should only be used along with its corresponding audit policy in an initiative. For more information on Guest Configuration policies, please visit https://aka.ms/gcpol",
    "mode": "Indexed"
  }
}
